# Data Model: Redis Streams Event-Driven Architecture

## Entities

### Event Stream

A logical channel for related events that maintains ordering and supports multiple consumers.

| Field | Type | Description |
|-------|------|-------------|
| name | string | Unique identifier for the stream (e.g., "events", "data-updates") |
| retention_ms | int | Time in milliseconds before messages are auto-deleted (default: 86400000 = 24h) |
| max_length | int | Maximum number of messages before oldest are trimmed |
| created_at | timestamp | When the stream was first created |

### Event Message

The data transmitted through a stream.

| Field | Type | Description |
|-------|------|-------------|
| id | string | Auto-generated by Redis (format: timestamp-sequence) |
| stream | string | Parent stream name |
| event_type | string | Classification for routing (e.g., "data.update", "alert") |
| payload | string | JSON-encoded event data |
| timestamp | string | ISO 8601 timestamp when event was produced |
| metadata | map | Optional key-value pairs for routing/filtering |

### Consumer Group

A named collection of consumers that share stream access while maintaining individual progress tracking.

| Field | Type | Description |
|-------|------|-------------|
| name | string | Group identifier |
| stream | string | Associated stream name |
| consumers | list | Active consumers in group |
| pending_count | int | Number of unacknowledged messages |

### Consumer

A service or process that reads events from a stream.

| Field | Type | Description |
|-------|------|-------------|
| name | string | Unique identifier for this consumer instance |
| group | string | Consumer group name |
| stream | string | Stream being consumed |
| position | string | Last acknowledged message ID |
| status | enum | "active", "idle", "disconnected" |

### Checkpoint

A marker indicating the last successfully processed event position for a consumer.

| Field | Type | Description |
|-------|------|-------------|
| consumer | string | Consumer name |
| group | string | Consumer group |
| stream | string | Stream name |
| message_id | string | Last processed message ID |
| timestamp | string | When checkpoint was saved |

---

## Validation Rules

1. **Event payload size**: Must be under 1MB
2. **Event type**: Required, non-empty string
3. **Consumer name**: Required, unique within group
4. **Stream name**: Required, alphanumeric with hyphens/underscores
5. **Consumer group**: Must exist before consumers can join

---

## State Transitions

### Consumer Lifecycle
```
[Created] --> [Active] --> [Idle] --> [Disconnected]
    ^           |           |            |
    |           v           v            v
    +-----------+-----------+------------+
                  (can rejoin)
```

### Message Lifecycle
```
[Pending] --> [In-Processing] --> [Acknowledged]
                ^                      |
                |                      v
                +-------(failure)------+
```

---

## Relationships

```
Event Stream 1--* Event Message
Event Stream 1--* Consumer Group
Consumer Group 1--* Consumer
Consumer Group *--* Checkpoint (one per consumer)
```

---

## API Surface (for libraries)

### Producer API
```python
class StreamProducer:
    def __init__(self, redis_url: str, stream_name: str, max_length: int = 10000)
    def publish(event_type: str, payload: dict, metadata: dict = None) -> str  # returns message_id
    def close()

class StreamManager:
    def __init__(self, redis_url: str)
    def create_stream(name: str, retention_ms: int = 86400000, max_length: int = None)
    def delete_stream(name: str)
    def get_stream_info(name: str) -> dict
```

### Consumer API
```python
class StreamConsumer:
    def __init__(self, redis_url: str, stream: str, group: str, consumer: str)
    def subscribe(callback: callable, event_types: list = None)  # blocking
    def acknowledge(message_id: str)
    def get_pending() -> list
    def close()

class ConsumerGroupManager:
    def __init__(self, redis_url: str)
    def create_group(stream: str, group: str, start_id: str = "0")
    def delete_group(stream: str, group: str)
    def list_groups(stream: str) -> list
    def get_group_info(stream: str, group: str) -> dict
```
